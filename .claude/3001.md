# GitHub Copilot Fix Instructions
## TypeError: `updateMaskingStatusBar` is not a function

---

### The Error
```
TypeError: (0 , maskingEngine_1.updateMaskingStatusBar) is not a function
    at handleCopyWithContext (src/commands/copyWithContext.ts:174:31)
```

---

### Root Cause: Circular Dependency

`csv.ts` imports from the barrel file `index.ts`, creating a circular require loop:

```
index.ts  →  exports from  →  csv.ts
csv.ts    →  imports from  →  index.ts   ← CIRCULAR
```

**Exact line causing the loop:**
- [src/utils/masking/csv.ts:7](src/utils/masking/csv.ts#L7)
  ```typescript
  import { maskGeneric, MASKING_FUNCTIONS } from '.';
  ```

**Why this breaks `updateMaskingStatusBar`:**

When Node.js hits the circular `require(".")` inside `csv.js`, it returns `index.js`'s exports object *as it exists at that moment* — partially populated. Because `csv.js` is required by `index.js` at line 86 of the compiled output, and `MASKING_FUNCTIONS` is set up at line 89 (after csv is loaded), Node caches the partial exports object. Under certain timing and access patterns in the VS Code extension host, this partial/stale object reference propagates up through `maskingEngine.js` and causes `updateMaskingStatusBar` to resolve as `undefined` at call time.

**Evidence:**
- `out/utils/masking/csv.js` line 8: `const _1 = require(".");` — confirms circular require at runtime
- `out/utils/masking/index.js` line 86: `var csv_1 = require("./csv");` — csv is required AFTER ui getters are set up, but BEFORE `MASKING_FUNCTIONS` getter
- The compiled `out/utils/maskingEngine.js` contains stale exports (`shouldMaskColumn`, `formatOutputWithMaskingStats`) and embedded comments in getters that don't exist in the current TypeScript source — confirming the `out/` directory is out of sync with `src/`

---

### Fix Instructions for Copilot

Perform these steps in order. Do NOT skip any.

---

#### Step 1: Break the circular dependency in `csv.ts`

**File:** `src/utils/masking/csv.ts`

**Change line 7** from:
```typescript
import { maskGeneric, MASKING_FUNCTIONS } from '.';
```

**To:**
```typescript
import { maskGeneric, MASKING_FUNCTIONS } from './maskingFunctions';
```

**Why:** `maskGeneric` and `MASKING_FUNCTIONS` are both exported by `maskingFunctions.ts` directly. Importing from `'.'` (the barrel `index.ts`) is what creates the circular dependency. Importing from the source module directly eliminates the loop entirely.

**Verification:** After this change, `csv.ts` should have NO import from `'.'` or `'./index'`. Its imports should be:
```typescript
import { MaskingConfig, MaskedResult, Detection, PiiType } from './config';
import { parseCsvLine, shouldMaskColumn, detectColumnType } from './csvHelpers';
import { applyPreset } from './presets';
import { maskGeneric, MASKING_FUNCTIONS } from './maskingFunctions';
```

---

#### Step 2: Remove stale debug console.logs from compiled output

**File:** `out/utils/masking/index.js`

**Delete lines 73–75** (the debug logs added in the previous session):
```javascript
console.log('DEBUG [masking/index.js] ui_1 loaded:', ui_1);
console.log('DEBUG [masking/index.js] ui_1.updateMaskingStatusBar:', ui_1.updateMaskingStatusBar);
console.log('DEBUG [masking/index.js] ui_1.showMaskingNotification:', ui_1.showMaskingNotification);
```

These were added for debugging and should not remain.

---

#### Step 3: Clean rebuild

Run these commands in order:
```bash
cd "c:\Users\donald.chan\Documents\Github\copy-info-with-context"
rm -rf out
npm run compile
```

The `rm -rf out` is critical — the compiled `out/` directory contains stale `.js` files that do not match the current TypeScript source (evidence: `maskingEngine.js` exports `shouldMaskColumn` and `formatOutputWithMaskingStats` which no longer exist in the TypeScript source). A fresh compile from a clean `out/` directory is the only way to guarantee the compiled JavaScript reflects the current source.

---

#### Step 4: Verify the fix

After compilation, confirm:

1. **No circular require in csv.js:**
   ```bash
   grep "require" out/utils/masking/csv.js
   ```
   Should show `./csvHelpers`, `./presets`, `./maskingFunctions` — but NOT `"."` or `"./index"`.

2. **No stale exports in maskingEngine.js:**
   ```bash
   grep "shouldMaskColumn\|formatOutputWithMaskingStats" out/utils/maskingEngine.js
   ```
   Should return no results.

3. **No debug logs in index.js:**
   ```bash
   grep "DEBUG" out/utils/masking/index.js
   ```
   Should return no results.

4. **Compile succeeds with zero errors.**

---

### Summary of Changes

| File | Change |
|------|--------|
| `src/utils/masking/csv.ts` | Line 7: change `from '.'` to `from './maskingFunctions'` |
| `out/utils/masking/index.js` | Delete 3 debug console.log lines (73–75) |
| `out/` directory | Delete entirely, then `npm run compile` |

Only one source file is modified. The `out/` changes are handled by the clean rebuild.
